networks:
  cloudflared-internet:
  cloudflared-keycloak:
    internal: true
  keycloak-postgres:
    internal: true

volumes:
  cloudflared-home:
  postgres-data:

services:
  cloudflared:
    image: ghcr.io/giganticminecraft/cloudflared-with-auto-dns-route:b471d0c
    volumes:
      - cloudflared-home:/root
      - ./cloudflared/tunnel-config.yml:/image/tunnel-config.yml
    networks:
      - cloudflared-internet
      - cloudflared-keycloak

  keycloak:
    image: quay.io/keycloak/keycloak:16.1.0
    networks:
      - cloudflared-keycloak
      - keycloak-postgres
    env_file:
      - ${KEYCLOAK_ENV_FILE_PATH}
    environment:
      - DB_VENDOR=postgres
      - DB_ADDR=postgres
      - DB_PORT=5432
      - DB_DATABASE=keycloak
      - DB_USER=keycloak
      # DB_PASSWORD to be provided by .keycloak.env
      - KEYCLOAK_USER=admin
      # KEYCLOAK_PASSWORD to be provided by .keycloak.env
      - PROXY_ADDRESS_FORWARDING=true
      - KEYCLOAK_FRONTEND_URL=https://auth.seichi.click/auth

  postgres:
    image: postgres:9.6.24-bullseye
    networks:
      - keycloak-postgres
    env_file:
      - ${POSTGRES_ENV_FILE_PATH}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      # POSTGRES_PASSWORD to be provided by .postgres.env
