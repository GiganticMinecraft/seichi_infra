apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: seichiassist-downloader
  namespace: seichi-minecraft
spec:
  template:
    serviceAccountName: seichiassist-downloader-sensor-sa
  eventBusName: seichiassist-downloader
  dependencies:
    - name: from-seichiassist-downloader
      eventSourceName: seichiassist-downloader
      eventName: SeichiAssistReleaseEventSource
      filters:
        data:
          - path: headers.X-Github-Event
            type: string
            value:
              - release
          - path: body.action
            type: string
            value:
              - published
          - path: body.release.target_commitish
            type: string
            value:
              - "master"
              - "develop"
  triggers:
    - template:
        name: seichiassist-release-trigger
        k8s:
          operation: create
          source:
            resource:
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: github-
              spec:
                serviceAccountName: seichiassist-downloader-workflow-sa
                entrypoint: download-seichiassist
                onExit: notify-discord
                volumeClaimTemplates:
                  - metadata:
                      name: work
                    spec:
                      accessModes: ["ReadWriteOnce"]
                      resources:
                        requests:
                          storage: 1Gi
                arguments:
                  parameters:
                    - name: target-branch
                    - name: tag-name
                    - name: release-body
                templates:
                  - name: download-seichiassist
                    steps:
                      - - name: download
                          template: download-release
                      - - name: upload
                          template: upload-artifact
                      - - name: restart-debug-server
                          when: "'{{workflow.parameters.target-branch}}' == 'develop'"
                          template: restart-debug-server
                  - name: download-release
                    container:
                      image: alpine:3.23
                      volumeMounts:
                        - name: work
                          mountPath: /work
                      command: [sh, -c]
                      args:
                        [
                          "wget -P /work https://github.com/GiganticMinecraft/SeichiAssist/releases/download/{{ workflow.parameters.tag-name }}/SeichiAssist.jar",
                        ]
                  - name: upload-artifact
                    container:
                      image: amazon/aws-cli:latest
                      env:
                        - name: AWS_ACCESS_KEY_ID
                          valueFrom:
                            secretKeyRef:
                              name: garage-s3-credentials
                              key: AWS_ACCESS_KEY_ID
                        - name: AWS_SECRET_ACCESS_KEY
                          valueFrom:
                            secretKeyRef:
                              name: garage-s3-credentials
                              key: AWS_SECRET_ACCESS_KEY
                      volumeMounts:
                        - name: work
                          mountPath: /work
                      command: [sh, -c]
                      args: [
                          "aws --endpoint-url http://garage.garage.svc.cluster.local:3900 --region seichi-cloud s3 cp /work/SeichiAssist.jar s3://seichiassist/{{ workflow.parameters.target-branch }}/SeichiAssist.jar",
                        ]
                  - name: restart-debug-server
                    steps:
                      - - name: patch-statefulset-to-0
                          template: patch-debug-statefulset-to-0
                      - - name: wait-for-scale-to-0
                          template: wait-for-debug-scale-to-0
                      - - name: patch-statefulset-to-1
                          template: patch-debug-statefulset-to-1
                      - - name: wait-for-scale-to-1
                          template: wait-for-debug-scale-to-1
                  - name: patch-debug-statefulset-to-0
                    script:
                      image: bitnami/kubectl:latest
                      command: ["/bin/sh", "-c"]
                      source: |
                        kubectl patch statefulset mcserver--debug-s1 -n seichi-debug-minecraft --type='merge' -p '{"spec": {"replicas": 0}}'
                        kubectl patch statefulset mcserver--debug-s2 -n seichi-debug-minecraft --type='merge' -p '{"spec": {"replicas": 0}}'
                  - name: wait-for-debug-scale-to-0
                    script:
                      image: bitnami/kubectl:latest
                      command: ["/bin/sh", "-c"]
                      source: |
                        echo "Waiting for statefulsets to scale down..."
                        for sts in mcserver--debug-s1 mcserver--debug-s2; do
                          while true; do
                            replicas=$(kubectl get statefulset "$sts" -n seichi-debug-minecraft -o jsonpath='{.status.availableReplicas}')
                            if [ -z "$replicas" ] || [ "$replicas" -eq 0 ]; then
                              break
                            fi
                            echo "$sts still scaling down..."
                            sleep 5
                          done
                          echo "$sts scale-down confirmed!"
                        done
                  - name: patch-debug-statefulset-to-1
                    script:
                      image: bitnami/kubectl:latest
                      command: ["/bin/sh", "-c"]
                      source: |
                        kubectl patch statefulset mcserver--debug-s1 -n seichi-debug-minecraft --type='merge' -p '{"spec": {"replicas": 1}}'
                        kubectl patch statefulset mcserver--debug-s2 -n seichi-debug-minecraft --type='merge' -p '{"spec": {"replicas": 1}}'
                  - name: wait-for-debug-scale-to-1
                    activeDeadlineSeconds: 300
                    script:
                      image: bitnami/kubectl:latest
                      command: ["/bin/sh", "-c"]
                      source: |
                        echo "Waiting for StatefulSets to scale up..."
                        for sts in mcserver--debug-s1 mcserver--debug-s2; do
                          while [ "$(kubectl get statefulset "$sts" -n seichi-debug-minecraft -o jsonpath='{.status.availableReplicas}')" != "1" ]; do
                            echo "$sts still scaling up..."
                            sleep 5
                          done
                          echo "$sts scale-up confirmed!"
                        done
                  - name: notify-discord
                    steps:
                      - - name: notify-succeeded-on-develop
                          when: "'{{workflow.parameters.target-branch}}' == 'develop' && '{{workflow.status}}' == 'Succeeded'"
                          template: send-discord-embed
                          arguments:
                            parameters:
                              - name: embed-title
                                value: "SeichiAssist がデバッグサーバーに配置されました"
                              - name: embed-description
                                value: "新しいバージョンのプラグインが配置され、サーバーが再起動されました。"
                              - name: embed-color
                                value: "5763719"
                      - - name: notify-failed-on-develop
                          when: "'{{workflow.parameters.target-branch}}' == 'develop' && ('{{workflow.status}}' == 'Failed' || '{{workflow.status}}' == 'Error')"
                          template: send-discord-embed
                          arguments:
                            parameters:
                              - name: embed-title
                                value: "SeichiAssist のデバッグサーバーへの配置に失敗しました"
                              - name: embed-description
                                value: ""
                              - name: embed-color
                                value: "15548997"
                      - - name: notify-succeeded-on-master
                          when: "'{{workflow.parameters.target-branch}}' == 'master' && '{{workflow.status}}' == 'Succeeded'"
                          template: send-discord-embed-for-master
                          arguments:
                            parameters:
                              - name: embed-title
                                value: "【アップデートのお知らせ】次回再起動時に SeichiAssist {{workflow.parameters.tag-name}} が適用されます。"
                              - name: embed-color
                                value: "5763719"
                  - name: send-discord-embed
                    inputs:
                      parameters:
                        - name: embed-title
                        - name: embed-description
                        - name: embed-color
                    container:
                      image: curlimages/curl:8.18.0
                      env:
                        - name: DISCORD_WEBHOOK_URL
                          valueFrom:
                            secretKeyRef:
                              name: seichiassist-downloader-develop-release-notify-webhook
                              key: DISCORD_WEBHOOK_URL
                      command: [sh, -ceu]
                      args:
                        - |
                          payload=$(cat <<EOF
                          {
                            "embeds": [
                              {
                                "title": "{{inputs.parameters.embed-title}}",
                                "description": "{{inputs.parameters.embed-description}}",
                                "color": {{inputs.parameters.embed-color}},
                                "fields": [
                                  { "name": "tag", "value": "{{workflow.parameters.tag-name}}", "inline": true },
                                  { "name": "リリースページ", "value": "[{{workflow.parameters.tag-name}}](https://github.com/GiganticMinecraft/SeichiAssist/releases/tag/{{workflow.parameters.tag-name}})", "inline": false }
                                ]
                              }
                            ]
                          }
                          EOF
                          )
                          curl -fSs -X POST \
                            -H "Content-Type: application/json" \
                            --data "${payload}" \
                            "${DISCORD_WEBHOOK_URL}"
                  - name: send-discord-embed-for-master
                    inputs:
                      parameters:
                        - name: embed-title
                        - name: embed-color
                    container:
                      image: alpine:3.23
                      env:
                        - name: DISCORD_WEBHOOK_URL
                          valueFrom:
                            secretKeyRef:
                              name: seichiassist-downloader-master-release-notify-webhook
                              key: DISCORD_WEBHOOK_URL
                        - name: EMBED_TITLE
                          value: "{{inputs.parameters.embed-title}}"
                        - name: EMBED_COLOR
                          value: "{{inputs.parameters.embed-color}}"
                      command: [sh, -ceu]
                      args:
                        - |
                          apk add --no-cache curl jq > /dev/null 2>&1

                          cat > /tmp/release-body.txt << '__RELEASE_BODY_BOUNDARY__'
                          {{workflow.parameters.release-body}}
                          __RELEASE_BODY_BOUNDARY__

                          # Discord embed description の 4096 文字制限に対応
                          body=$(head -c 4000 /tmp/release-body.txt)
                          if [ "$(wc -c < /tmp/release-body.txt)" -gt 4000 ]; then
                            body="${body}... (以降省略)"
                          fi

                          TAG_NAME="{{workflow.parameters.tag-name}}"

                          payload=$(jq -n \
                            --arg title "${EMBED_TITLE}" \
                            --arg desc "$body" \
                            --argjson color "${EMBED_COLOR}" \
                            --arg tag "${TAG_NAME}" \
                            '{
                              content: "<@&959293755133935657>",
                              allowed_mentions: { roles: ["959293755133935657"] },
                              embeds: [{
                                title: $title,
                                description: $desc,
                                color: $color,
                                fields: [
                                  { name: "tag", value: $tag, inline: true },
                                  { name: "リリースページ", value: ("[\($tag)](https://github.com/GiganticMinecraft/SeichiAssist/releases/tag/\($tag))"), inline: false }
                                ]
                              }]
                            }')

                          curl -fSs -X POST \
                            -H "Content-Type: application/json" \
                            --data "${payload}" \
                            "${DISCORD_WEBHOOK_URL}"
          parameters:
            - src:
                dependencyName: from-seichiassist-downloader
                dataKey: body.release.target_commitish
              dest: spec.arguments.parameters.0.value
            - src:
                dependencyName: from-seichiassist-downloader
                dataKey: body.release.tag_name
              dest: spec.arguments.parameters.1.value
            - src:
                dependencyName: from-seichiassist-downloader
                dataKey: body.release.body
              dest: spec.arguments.parameters.2.value
            - src:
                dependencyName: from-seichiassist-downloader
                dataKey: body.release.tag_name
              dest: metadata.name
              operation: append
      retryStrategy:
        steps: 3
