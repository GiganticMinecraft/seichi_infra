apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mcserver--migrator
  namespace: seichi-minecraft
  labels:
    app: mcserver--migrator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mcserver--migrator
  template:
    metadata:
      labels:
        app: mcserver--migrator
        mcserver: migrator
    spec:
      containers:
        - resources:
            requests:
              cpu: 8
              memory: 30Gi
            limits:
              cpu: 10
              memory: 30Gi
          env:
            - name: MEMORY
              value: "28G"
            - name: EULA
              value: "TRUE"

            - name: JVM_OPTS
              # base image 側で JVM_OPTS に対して jmx exporter の設定を追加しているが、上書きが必要なためここで設定する
              # SeichiAssistによるワールドマイグレーションをするとメモリリークが発生するため、Papermc公式が推奨しているJVM Optionを追加する
              # ref: https://docs.papermc.io/paper/aikars-flags
              value: >-
                -javaagent:/jmx-exporter/jmx_prometheus_javaagent.jar=18321:/jmx-exporter/jmx-exporter-config.yaml
                -XX:+UseG1GC -XX:+ParallelRefProcEnabled -XX:MaxGCPauseMillis=200 
                -XX:+UnlockExperimentalVMOptions -XX:+DisableExplicitGC -XX:+AlwaysPreTouch 
                -XX:G1NewSizePercent=30 -XX:G1MaxNewSizePercent=40 -XX:G1HeapRegionSize=8M 
                -XX:G1ReservePercent=20 -XX:G1HeapWastePercent=5 -XX:G1MixedGCCountTarget=4 
                -XX:InitiatingHeapOccupancyPercent=15 -XX:G1MixedGCLiveThresholdPercent=90 
                -XX:G1RSetUpdatingPauseTimePercent=5 -XX:SurvivorRatio=32 -XX:+PerfDisableSharedMem 
                -XX:MaxTenuringThreshold=1 -Dusing.aikars.flags=https://mcflags.emc.gs 
                -Daikars.new.flags=true

            - name: RCON_CMDS_STARTUP
              value: |-
                fixer deserialize

            - name: VERSION
              value: "1.12.2"

            - name: TYPE
              value: "PAPER"

            - name: MODS
              value: >-
                https://github.com/GiganticMinecraft/SerializedItemStackFixer/releases/download/sha-f8ab2c8/SerializedItemStackFixer-1-12.jar

            - name: REMOVE_OLD_MODS
              value: "TRUE"

            - name: REPLACE_ENV_VARIABLE_PREFIX
              value: "CFG_"

            - name: CFG_MYSQL_HOST
              value: "mariadb"

            - name: CFG_MYSQL_PORT
              value: "3306"

            - name: CFG_MYSQL_USER
              value: "mcserver"

            - name: CFG_MYSQL_USER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mariadb
                  key: mcserver-password

          image: itzg/minecraft-server:java8-jdk
          name: minecraft
          ports:
            - containerPort: 25565
              name: minecraft

          startupProbe:
            tcpSocket:
              port: 25565
            # 最大120秒待つ
            failureThreshold: 6
            periodSeconds: 20

          readinessProbe:
            exec:
              command:
                - mc-monitor
                - status
                - --host
                - localhost
                - --port
                - "25565"
            initialDelaySeconds: 30
            periodSeconds: 5
            failureThreshold: 18

          volumeMounts:
            - name: mcserver--itemstack-migrator-data
              mountPath: /data
            - name: serialized-itemstack-fixer-config
              mountPath: /plugins/SerializedItemStackFixer/config.yml
              subPath: config.yml

      volumes:
        - name: serialized-itemstack-fixer-config
          configMap:
            name: serialized-itemstack-fixer-config

  volumeClaimTemplates:
    - apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: mcserver--itemstack-migrator-data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 50Gi
