apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: upload-world-to-minio
  namespace: seichi-debug-minecraft
  annotations:
    workflows.argoproj.io/description: "最新PBSバックアップからワールドデータを抽出し、MinIOにアップロードするワークフロー"
spec:
  serviceAccountName: upload-world-to-minio-workflow-sa
  ttlStrategy:
    secondsAfterCompletion: 86400
  activeDeadlineSeconds: 7200 # 2時間でタイムアウト（リストア+圧縮+アップロードに時間がかかる可能性）
  entrypoint: default
  arguments:
    parameters:
      - name: server-names
        value: '["s1", "s2"]'
  templates:
    - name: default
      steps:
        - - name: restore-and-upload
            template: restore-and-upload
            arguments:
              parameters:
                - name: server-name
                  value: "{{item}}"
            withParam: "{{workflow.parameters.server-names}}"

    - name: restore-and-upload
      inputs:
        parameters:
          - name: server-name
      script:
        image: debian:13
        command: ["/bin/sh", "-c"]
        source: |
          set -e

          echo "=== Installing proxmox-backup-client ==="
          apt update
          apt install -y curl zstd python3

          echo "Adding Proxmox Backup Client repository..."
          echo "deb http://download.proxmox.com/debian/pbs-client trixie main" > /etc/apt/sources.list.d/pbs-client.list
          curl -fsSL https://enterprise.proxmox.com/debian/proxmox-release-trixie.gpg -o /etc/apt/trusted.gpg.d/proxmox-release-trixie.gpg

          apt update
          apt install -y proxmox-backup-client=4.0.14-1

          echo "=== Finding latest {{inputs.parameters.server-name}} snapshot ==="
          LATEST_SNAPSHOT=$(proxmox-backup-client snapshot list \
            --repository "${PBS_USER}@${PBS_HOST}:${PBS_DATASTORE}" \
            --output-format json \
            | python3 -c "
          import json, sys, datetime
          snapshots = json.load(sys.stdin)
          s1_snapshots = [s for s in snapshots if s['backup-id'] == 'mcserver--{{inputs.parameters.server-name}}']
          if not s1_snapshots:
              print('No mcserver--{{inputs.parameters.server-name}} snapshots found', file=sys.stderr)
              sys.exit(1)
          latest = max(s1_snapshots, key=lambda s: s['backup-time'])
          ts = datetime.datetime.fromtimestamp(latest['backup-time'], tz=datetime.timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ')
          print(f\"host/mcserver--{{inputs.parameters.server-name}}/{ts}\")
          ")
          echo "Latest snapshot: ${LATEST_SNAPSHOT}"

          echo "=== Restoring from PBS ==="
          proxmox-backup-client restore "${LATEST_SNAPSHOT}" \
            data.pxar /restore \
            --repository "${PBS_USER}@${PBS_HOST}:${PBS_DATASTORE}"

          echo "=== Restore contents ==="
          ls -la /restore/

          echo "=== Removing non-world data to free disk space ==="
          # ワールドデータ（playerdata/ を含むディレクトリ）以外を削除する
          WORLD_DIRS=$(find /restore -type d -name playerdata -exec dirname {} \;)
          find /restore -mindepth 1 -maxdepth 1 -print0 | while IFS= read -r -d '' entry; do
            IS_WORLD=false
            for wd in $WORLD_DIRS; do
              case "$wd" in
                "$entry"|"$entry"/*) IS_WORLD=true; break ;;
              esac
            done
            if [ "$IS_WORLD" = false ]; then
              echo "Removing: $entry"
              rm -rf "$entry"
            fi
          done
          echo "Remaining contents after cleanup:"
          ls -la /restore/

          echo "=== Installing MinIO client ==="
          curl -fsSL https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc
          chmod +x /usr/local/bin/mc

          echo "=== Configuring MinIO client ==="
          /usr/local/bin/mc alias set myminio "http://seichi-private-plugin-blackhole-minio.minio:9000" "${MINIO_ACCESS_KEY}" "${MINIO_ACCESS_SECRET}"

          echo "=== Finding world directories (containing playerdata/) ==="
          WORLD_DIRS=$(find /restore -type d -name playerdata | while read -r pd; do dirname "$pd"; done)

          if [ -z "$WORLD_DIRS" ]; then
            echo "ERROR: No world directories (containing playerdata/) found in backup"
            exit 1
          fi

          echo "Found world directories:"
          echo "$WORLD_DIRS"

          echo "=== Compressing and uploading each world ==="
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)

          echo "$WORLD_DIRS" | while read -r WORLD_DIR; do
            WORLD_NAME=$(basename "$WORLD_DIR")
            FILENAME="${WORLD_NAME}-${TIMESTAMP}.tar.zst"

            echo "--- Compressing ${WORLD_NAME} ---"
            tar cf - -C "$WORLD_DIR" . | zstd -o "/tmp/${FILENAME}"
            echo "Compressed file size: $(du -h /tmp/${FILENAME} | cut -f1)"

            echo "--- Uploading ${WORLD_NAME} ---"
            /usr/local/bin/mc cp "/tmp/${FILENAME}" "myminio/mc-worlds/{{inputs.parameters.server-name}}/${FILENAME}"
            echo "Uploaded: mc-worlds/{{inputs.parameters.server-name}}/${FILENAME}"

            rm -f "/tmp/${FILENAME}"
          done

          echo "=== All worlds uploaded ==="
        env:
          - name: TZ
            value: "Asia/Tokyo"
          - name: PBS_USER
            valueFrom:
              secretKeyRef:
                name: pbs-credentials
                key: user
          - name: PBS_HOST
            valueFrom:
              secretKeyRef:
                name: pbs-credentials
                key: host
          - name: PBS_DATASTORE
            valueFrom:
              secretKeyRef:
                name: pbs-credentials
                key: datastore
          - name: PBS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: pbs-credentials
                key: password
          - name: PBS_FINGERPRINT
            valueFrom:
              secretKeyRef:
                name: pbs-credentials
                key: fingerprint
          - name: MINIO_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: minio-access-secret
                key: MINIO_ACCESS_KEY
          - name: MINIO_ACCESS_SECRET
            valueFrom:
              secretKeyRef:
                name: minio-access-secret
                key: MINIO_ACCESS_SECRET
        volumeMounts:
          - name: work-volume
            mountPath: /restore
            subPath: restore
          - name: work-volume
            mountPath: /tmp
            subPath: tmp
          # /root/.cache が overlayfs 配下だとスクリプトがこけるので O_TMPFILE フラグ付きの openat(2) が実行可能なファイルシステムをマウントする
          # refs: https://gist.github.com/unchama/0922fce3c490e46b6f9e822f4377853e
          - name: work-volume
            mountPath: /root/.cache
            subPath: pbs-cache
      # NOTE: 本当はエフェメラルボリュームにしたかったが、ワールドデータが巨大すぎてできなかったので PVC を使用している
      volumeClaimTemplates:
        - metadata:
            name: work-volume
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 40Gi
