apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: seichi-debug-redisbungee-redis
  namespace: argocd
spec:
  project: seichi-debug-minecraft
  source:
    chart: redis
    repoURL: https://charts.bitnami.com/bitnami
    targetRevision: 17.13.2
    helm:
      releaseName: seichi-debug-redisbungee-redis
      values: |
        architecture: standalone 
        auth:
          enabled: false
        commonConfiguration: |-
          notify-keyspace-events "Eg$x"
        master:
          service:
            type: LoadBalancer
            loadBalancerIP: 192.168.8.134
          resources:
            requests:
              cpu: "250m"
              memory: "1Gi"
          extraFlags:
            # https://github.com/GiganticMinecraft/seichi_infra/issues/468
            - "--maxmemory 2048mb"
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
            additionalLabels:
              release: prometheus
          prometheusRule:
            enabled: true
            additionalLabels:
              release: prometheus
            rules:
              - alert: RedisDown
                expr: redis_up{service="{{ template "common.names.fullname" . }}-metrics"} == 0
                for: 2m
                labels:
                  severity: error
                annotations:
                  summary: Redis&reg; instance {{ "{{ $labels.instance }}" }} down
                  description: Redis&reg; instance {{ "{{ $labels.instance }}" }} is down
              - alert: RedisMemoryHigh
                expr: >
                  redis_memory_used_bytes{service="{{ template "common.names.fullname" . }}-metrics"} * 100
                  /
                  redis_memory_max_bytes{service="{{ template "common.names.fullname" . }}-metrics"}
                  > 90
                for: 2m
                labels:
                  severity: error
                annotations:
                  summary: Redis&reg; instance {{ "{{ $labels.instance }}" }} is using too much memory
                  description: |
                    Redis&reg; instance {{ "{{ $labels.instance }}" }} is using {{ "{{ $value }}" }}% of its available memory.
              - alert: RedisKeyEviction
                expr: |
                  increase(redis_evicted_keys_total{service="{{ template "common.names.fullname" . }}-metrics"}[5m]) > 0
                for: 1s
                labels:
                  severity: error
                annotations:
                  summary: Redis&reg; instance {{ "{{ $labels.instance }}" }} has evicted keys
                  description: |
                    Redis&reg; instance {{ "{{ $labels.instance }}" }} has evicted {{ "{{ $value }}" }} keys in the last 5 minutes.
  destination:
    server: https://kubernetes.default.svc
    namespace: seichi-debug-minecraft
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
