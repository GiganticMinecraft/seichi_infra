apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: newrelic
  namespace: argocd
spec:
  project: cluster-wide-apps
  source:
    chart: nri-bundle
    repoURL: https://helm-charts.newrelic.com
    targetRevision: 5.0.15
    helm:
      # https://github.com/newrelic/helm-charts/blob/nri-bundle-5.0.4/charts/nri-bundle/values.yaml
      values: |
        newrelic-infrastructure:
          privileged: true
          common:
            config:
              interval: 40s # default 15s
        global:
          lowDataMode: true
          customSecretName: "newrelic-credentials"
          customSecretLicenseKey: "LicenseKey"
          cluster: seichi-onp-k8s
        kube-state-metrics:
          enabled: true
          image:
            tag: "v2.7.0"
        kubeEvents:
          enabled: true
        newrelic-prometheus-agent:
          enabled: true
          lowDataMode: true
          config:
            common:
              scrape_interval: 120s # default 30s
            kubernetes:
              integrations_filter:
                enabled: false
        # nri-bundle の subchart である newrelic-pixie の設定
        # https://github.com/newrelic/helm-charts/blob/newrelic-pixie-2.0.2/charts/newrelic-pixie/values.yaml
        newrelic-pixie:
          enabled: true
          lowDataMode: true
          excludeNamespacesRegex: "default|kube-node-lease|kube-public|kube-system|newrelic|newrelic-custom-metrics|olm|px-operator"
          customSecretApiKeyName: "newrelic-credentials"
          customSecretApiKeyKey: "PixieApiKey"
        # nri-bundle の subchart である pixie-operator-chart の設定
        # https://github.com/pixie-io/pixie/blob/release/operator/v0.0.35/k8s/operator/helm/values.yaml
        pixie-chart:
          enabled: true
          # The deploy key may be read from a custom secret in the Pixie namespace.
          # This secret should be formatted where the key of the deploy key is "deploy-key".
          customDeployKeySecret: "newrelic-credentials"
          clusterName: seichi-onp-k8s
  destination:
    server: https://kubernetes.default.svc
    namespace: newrelic
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
