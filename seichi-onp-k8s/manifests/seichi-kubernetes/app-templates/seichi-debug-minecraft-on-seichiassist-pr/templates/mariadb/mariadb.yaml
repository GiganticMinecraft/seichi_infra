apiVersion: mariadb.mmontes.io/v1alpha1
kind: MariaDB
metadata:
  name: mariadb
spec:
  initContainers:
    - name: sqldump-exporter
      image: busybox:1.36.1
      env:
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mariadb-pr-review-password
              key: prod-mariadb-password
      volumeMounts:
        - name: sqldump-volume
          mountPath: /seichiassist.sql
      command:
        - "sh"
        - "-c"
        - 'mysqldump -umcserver -p${DB_PASSWORD} -h192.168.2.186 --databases seichiassist flyway_managed_schema > seichiassist.sql'

  rootPasswordSecretKeyRef:
    name: mariadb-pr-review-password
    key: root-password

  database: seichiassist
  username: mcserver
  passwordSecretKeyRef:
    name: mariadb-pr-review-password
    key: mcserver-password

  image: mariadb:10.11.6
  imagePullPolicy: IfNotPresent

  env:
    - name: MARIADB_ALLOW_EMPTY_ROOT_PASSWORD
      value: "true"

  port: 3306

  lifecycle:
    postStart:
      exec:
        command:
          - "sh"
          - "-c"
          - 'mysql -uroot -p"${MARIADB_ROOT_PASSWORD}" < seichiassist.sql'

  volumeClaimTemplate:
    resources:
      requests:
        storage: 5Gi
    storageClassName: synology-iscsi-storage-temp
    accessModes:
      - ReadWriteOnce

  volumeMounts:
    - name: sqldump-volume
      mountPath: /

  service:
    type: ClusterIP

  volumes:
    - name: sqldump-volume
      emptyDir: {}
