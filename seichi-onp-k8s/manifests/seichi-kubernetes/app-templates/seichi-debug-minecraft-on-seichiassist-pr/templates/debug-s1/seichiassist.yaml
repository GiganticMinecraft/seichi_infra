apiVersion: apps/v1
kind: StatefulSet
metadata:
  annotations:
    reloader.stakater.com/auto: "true"
  labels:
    app: mcserver
    mcserver: debug-s1
  name: mcserver--debug-s1
spec:
  replicas: 1
  serviceName: "mcserver--debug-s1"
  selector:
    matchLabels:
      app: mcserver--debug-s1
      mcserver: debug-s1
  template:
    metadata:
      labels:
        app: mcserver--debug-s1
        mcserver: debug-s1
    spec:
      initContainers:
        - name: jmx-exporter-downloader
          image: busybox:1.36.1
          env:
            - name: JMX_EXPORTER_URL
              value: "https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.16.1/jmx_prometheus_javaagent-0.16.1.jar"
          volumeMounts:
            - name: jmx-exporter-download-volume
              mountPath: /root/jmx-exporter-download
          command:
            - "sh"
            - "-c"
            - 'wget -O /root/jmx-exporter-download/jmx-exporter-javaagent.jar "${JMX_EXPORTER_URL}"'
        - name: mod-downloader
          image: ghcr.io/giganticminecraft/mod-downloader:sha-c0f7980
          env:
            - name: MINIO_ENDPOINT
              value: seichi-private-plugin-blackhole-minio.minio:9000
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-secrets
                  key: MINIO_ACCESS_KEY
            - name: MINIO_ACCESS_SECRET
              valueFrom:
                secretKeyRef:
                  name: minio-secrets
                  key: MINIO_ACCESS_SECRET
            - name: BUCKET_NAME
              value: seichi-plugins
            - name: BUCKET_PREFIX_NAME
              value: deb-1-18-2
            - name: DOWNLOAD_TARGET_DIR_PATH
              value: /plugins
          volumeMounts:
            - name: mod-downloader-volume
              mountPath: /plugins
        - name: world-downloader
          image: busybox:1.36.1
          env:
            - name: WORLD_URL # S1からインポートしてきたワールドデータ
              value: "http://seichi-private-plugin-blackhole-minio.minio:9000/seichi-plugins/world.tar.gz"
          volumeMounts:
            - name: world-download-volume
              mountPath: /data
          command:
            - "sh"
            - "-c"
            - 'wget -qO- "${WORLD_URL}" | tar -xz -C /data'

      containers:
        - resources:
            requests:
              cpu: 4
              memory: 8Gi
          env:
            - name: MEMORY
              value: 2048m
            - name: TYPE
              value: PAPER
            - name: VERSION
              value: "1.18.2"
            - name: EULA
              value: "TRUE"

            - name: REMOVE_OLD_MODS
              value: "TRUE"

            - name: MODS
              # DiscordSRV:
              #   https://github.com/DiscordSRV/DiscordSRV/releases/download/v1.25.1/DiscordSRV-Build-1.25.1.jar
              # LunaChat:
              #   https://github.com/ucchyocean/LunaChat/releases/download/v3.0.16/LunaChat.jar
              value: >-
                https://github.com/DiscordSRV/DiscordSRV/releases/download/v1.25.1/DiscordSRV-Build-1.25.1.jar,
                https://github.com/ucchyocean/LunaChat/releases/download/v3.0.16/LunaChat.jar,
                https://github.com/GiganticMinecraft/SeichiAssist/releases/download/pr-{{ .Values.SeichiAssistPullRequestNumber }}-{{ .Values.PullRequestBranchHeadSHA }}/SeichiAssist.jar,
                https://download.luckperms.net/1526/bukkit/loader/LuckPerms-Bukkit-5.4.113.jar,
                https://github.com/GiganticMinecraft/Elytra/releases/download/1.18.2/Elytra-1.0-SNAPSHOT.jar,

            - name: JVM_OPTS
              value: >-
                -javaagent:/jmx-exporter/jmx-exporter-javaagent.jar=18321:/jmx-exporter/jmx-exporter-config.yaml

            - name: COPY_CONFIG_DEST
              # /config をサーバーディレクトリにコピーするようにする
              # https://github.com/itzg/docker-minecraft-server/tree/9458005b5bd78b8139e13e66c29a449a12dd6218#optional-plugins-mods-and-config-attach-points
              value: /data

            # 設定ファイル内の ${CFG_*} の形をした部分を置き換える
            # https://github.com/itzg/docker-minecraft-server/tree/9458005b5bd78b8139e13e66c29a449a12dd6218#replacing-variables-inside-configs
            - name: REPLACE_ENV_VARIABLE_PREFIX
              value: CFG_

            - name: CFG_DISCORDSRV_TOKEN
              valueFrom:
                secretKeyRef:
                  name: mcserver--common--config-secrets
                  key: DISCORDSRV_TOKEN

            - name: CFG_DISCORDSRV_GLOBAL_CHANNEL_ID
              value: "1054159992447570032"

            - name: CFG_DISCORDSRV_CONSOLE_CHANNEL_ID
              value: "1054159676964622426"

            - name: RCON_CMDS_STARTUP
              value: |-
                mv create world_SW NORMAL
                mv create world_SW_2 NORMAL
                mv create world_SW_nether NETHER
                mv create world_SW_the_end END
                gamerule keepInventory true
                mv gamerule keepInventory true world_SW
                mv gamerule keepInventory true world_SW_2
                mv gamerule keepInventory true world_SW_nether
                mv gamerule keepInventory true world_SW_the_end
                lp group default permission set multiverse.core.list.who true
                lp group default permission set multiverse.teleport.* true
                lp group default permission set worldedit.wand true
                lp group default permission set worldguard.region.claim true
                lp group default permission set worldguard.region.select.own.* true
                lp group default permission set worldguard.region.list.own true
                lp group default permission set worldguard.region.info.own.* true
                lp group default permission set worldguard.region.flag.regions.own.* true
                lp group default permission set seichiassist.fly true
                lp group default permission set fastcraft.command.craft.fastcraft true
                lp group default permission set seichiassist.stick true
                lp group default permission set seichiassist.shareinv true
                lp group default permission set seichiassist.mebius true
                lp group default permission set seichiassist.home true
                lp group default permission set seichiassist.sethome true
                lp group default permission set seichiassist.stickmenu true
                lp group default permission set seichiassist.fd true
                lp group default permission set seichiassist.hat true
                lp group default permission set seichiassist.ec true
                lp group default permission set seichiassist.minestack true
                lp group default permission set seichiassist.map true
                lp group default permission set seichiassist.ef true
                lp group default permission set elytra.auto true
                lp group default permission set elytra.const-flight true
                lp group default permission set elytra.runup true
                lp group default permission set elytra.shift-activation true
                lp group default permission set elytra.speedup true
                
          image: ghcr.io/giganticminecraft/seichi_minecraft_server_debug_base_1_18_2:sha-1267b49
          name: minecraft
          ports:
            - containerPort: 25565
              name: minecraft
            - containerPort: 18321
              name: jmx-metrics

          startupProbe:
            tcpSocket:
              port: 25565
            # 最大120秒待つ
            failureThreshold: 6
            periodSeconds: 20

          readinessProbe:
            exec:
              command:
                - mc-monitor 
                - status 
                - --host 
                - localhost 
                - --port
                - "25565"
            initialDelaySeconds: 30
            periodSeconds: 5
            failureThreshold: 18

          volumeMounts:
            # itzg/minecraft-server は /config に設定ファイルをマウントしておけばコピーをしてくれる。
            # 環境変数の置き換えはPrefix等の設定が必要なので、必要になったら設定するように。
            # https://github.com/itzg/docker-minecraft-server/tree/9458005b5bd78b8139e13e66c29a449a12dd6218#replacing-variables-inside-configs

            # 普通にマウントすると、auto-update (常に最新のvolume内容がコンテナ内から見える) の挙動を
            # 提供するために symlink による一時ディレクトリがマウントされることになるが、
            # itzg/minecraft-server が利用するファイル同期の仕組み (itzg/mc-image-helper) は
            # symlink を展開してしまうため、設定ファイルのパスが壊れてしまう。
            #
            # subPathを利用してマウントすればsymlinkが作られることを回避できるためそのようにしている。
            # 参考: https://stackoverflow.com/a/63114800
            # 参考: https://stackoverflow.com/a/50687707

            # サーバーの設定ファイル
            - name: common-mcserver-configs
              mountPath: /config/bukkit.yml
              subPath: bukkit.yml
            - name: common-mcserver-configs
              mountPath: /config/paper.yml
              subPath: paper.yml
            - name: common-mcserver-configs
              mountPath: /config/server.properties
              subPath: server.properties
            - name: common-mcserver-configs
              mountPath: /config/spigot.yml
              subPath: spigot.yml
            - name: minecraft-ops-config
              mountPath: /config/ops.json
              subPath: ops.json

            # DiscordSRV プラグインの設定ファイル
            - name: common-mcserver-plugin-configs
              mountPath: /plugins/DiscordSRV/config.yml
              subPath: DiscordSRV-config.yml
            - name: common-mcserver-plugin-configs
              mountPath: /plugins/DiscordSRV/messages.yml
              subPath: DiscordSRV-messages.yml

            # MorningGlorySeeds プラグインの設定ファイル
            - name: common-mcserver-plugin-configs
              mountPath: /plugins/MorningGlorySeeds/config.yml
              subPath: MorningGlorySeeds-config.yml

            # LunaChat プラグインの設定ファイル
            - name: common-mcserver-plugin-configs
              mountPath: /plugins/LunaChat/config.yml
              subPath: LunaChat-config.yml

            # Elytra プラグインの設定ファイル
            - name: common-mcserver-plugin-configs
              mountPath: /plugins/Elytra/config.yml
              subPath: Elytra-config.yml

            # SeichiAssist プラグインの設定ファイル
            - name: seichiassist-config
              mountPath: /plugins/SeichiAssist/config.yml
              subPath: config.yml

            # JMX exporter 周りのファイルが入ったボリューム達のマウント設定
            - name: jmx-exporter-download-volume
              mountPath: /jmx-exporter/jmx-exporter-javaagent.jar
              subPath: jmx-exporter-javaagent.jar
            - name: world-download-volume
              mountPath: /data/world
            - name: common-jmx-exporter-config
              mountPath: /jmx-exporter/jmx-exporter-config.yaml
              subPath: jmx-exporter-config.yaml

            - name: mod-downloader-volume
              mountPath: /plugins

      volumes:
        - name: common-mcserver-configs
          configMap:
            name: common-mcserver-configs
        - name: common-mcserver-plugin-configs
          configMap:
            name: common-mcserver-plugin-configs
        - name: seichiassist-config
          configMap:
            name: seichiassist-config
        - name: minecraft-ops-config
          configMap:
            name: minecraft-ops-config
        
        # JMX exporterをinitContainerでダウンロードしてBugneeCordに受け渡すためのvolume
        - name: jmx-exporter-download-volume
          emptyDir: {}
        - name: world-download-volume
          emptyDir: {}
        - name: common-jmx-exporter-config
          configMap:
            name: common-jmx-exporter-config

        # mod-downloaderからプラグインをinitContainerでダウンロードしてBugneeCordに受け渡すためのvolume
        - name: mod-downloader-volume
          emptyDir: {}
