volumes:
  cloudflared-home:

services:
  cloudflared:
    image: ghcr.io/giganticminecraft/cloudflared-with-auto-dns-route:2f9a183
    volumes:
      - cloudflared-home:/root
      - ./cloudflared-tunnel-config.yml:/etc/cloudflared/tunnel-config.yml
    network_mode: "host"
    restart: always
    # votelitener-server
    # nuVotifierが待ち受けておりminecraft.jpやmonocraft.netで投票されるとここに投票パケットが飛ぶ
    # cloudflaredの仕様としてtcpトンネルの対向はcloudflared access tcpで終端してやる必要がある為
    # proxy-kubernetes上にcloudflaredを配置して終端し、そのポイントをService(Type: LoadBalancer)で公開する
    # よってここで指定するエンドポイントはproxy-kubernetes上のcloudflaredからしかアクセスしないため
    # cloudflare-service-tokenによるアクセス制御の範囲に含めて良い
    environment:
      TUNNEL_NAME: seichi-onp-network-iap-votelistener-tunnel
      CLOUDFLARED_HOSTNAME: votelistener.tcp-prod-network.seichi.click
      CLOUDFLARED_SERVICE: "tcp://192.168.2.99:32957"
