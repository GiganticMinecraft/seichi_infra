name: "本番環境の更新チェック"

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize]
    paths:
      - '.github/workflows/validate_production_manifests.yaml'
      - 'proxy-kubernetes/production-k8s-manifests/**'
      - 'proxy-kubernetes/base-k8s-manifests/**'

env:
  KUBECONFIG: kubeconfig.yaml

jobs:
  validate-production:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Validate production manifests
        uses: stefanprodan/kube-tools@v1
        with:
          kubectl: 1.23.1
          command: |
            echo "${{ secrets.DEPLOY_TARGET_K8S_KEY }}" | base64 -d > $KUBECONFIG
            echo "validate production manifests"

            kubectl diff -k proxy-kubernetes/production-k8s-manifests || true
