apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: argocd
  namespace: argocd
spec:
  project: default
  source:
    chart: proxy-k8s-argo-cd
    repoURL: https://giganticminecraft.github.io/seichi_infra
    targetRevision: 1.0.0
    helm:
      releaseName: proxy-k8s-argo-cd
      values: |
        # argo-cd is a dependency chart so we must override values like this
        # https://helm.sh/docs/chart_template_guide/subcharts_and_globals/
        argo-cd:
          server:
            configEnabled: true
            # -- [General Argo CD configuration]
            # @default -- See [values.yaml]
            config:
              # Argo CD instance label key
              application.instanceLabelKey: argocd.argoproj.io/instance
              kustomize.buildOptions: --load-restrictor LoadRestrictionsNone
              kustomize.buildOptions.v4.4.0: --output /tmp
              ## Following settings are required when configuring SSO
              # Argo CD's externally facing base URL (optional).
              url: https://argocd.bungee-proxy-public.seichi.click
              dex.config: |
                connectors:
                  - type: github
                    id: github
                    name: GitHub
                    config:
                      clientID: 6d77699f96a51159ce39
                      clientSecret: $argocd-github-client-secret:dex.github.clientSecret
                      orgs:
                      - name: GiganticMinecraft

            rbacConfig:
              # policy.csv is an file containing user-defined RBAC policies and role definitions (optional).
              # Policy rules are in the form:
              #   p, subject, resource, action, object, effect
              # Role definitions and bindings are in the form:
              #   g, subject, inherited-subject
              # See https://github.com/argoproj/argo-cd/blob/master/docs/operator-manual/rbac.md for additional information.
              policy.csv: |
                g, GiganticMinecraft:admin-team, role:admin
                g, GiganticMinecraft:infra-collaborator, role:admin
              # policy.default is the name of the default role which Argo CD will falls back to, when
              # authorizing API requests (optional). If omitted or empty, users may be still be able to login,
              # but will see no apps, projects, etc...
              policy.default: role:readonly
  destination:
    server: https://kubernetes.default.svc
    namespace: argocd
  syncPolicy:
    automated:
      prune: true
    syncOptions:
    - CreateNamespace=true
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: argocd-github-client-secret
  namespace: argocd
spec:
  encryptedData:
    dex.github.clientSecret: AgAiKdiKEUldBBAtjjei6wOD4gPu+w+Vt/6Pahxpwx6VE9gRMm+p29yFMeJKv9VRsZRJ+Gu6rsRgGSP1fu+yM5QMt5SGipv+rabxt5UuRC6zlU+hk1RI0m0tojE2sjsslvclqqmDfqPnNGLOz0CXyUsIOdm18WqjYKM67D+HKbXNuXHE8okhki37z3ABK91z8BBw0tQaU8D6Os/ZVuo2baAXBkUb+6OBY6SCMt1mIfQhNYU9qgMa0Lq2Xm55ZPgSorad0JKw1Ah2hAP6xEx9c36gv240kbpuSzdQgw8iTabutyMva0QNeiQT3oZ8KGGyUkYyVfZSsC8BT2j0R2WC/VKuBxevpBs5MDSmvncQxb7aYmwdQB6+X9lkCC0NgmeR/TB4XS2IGWPuZ9hmsTAZT2hb9id6SWra6aNq0Uf11TJRwc4JpQL2iJwc1Ao/lDKWIdy5lzjnI65xeajiUrdgo6IBIMBSMIjbxgeVpBL+hd0yhJ4cn1pOIpHcpsSGtnsfbvSfRozAvtvYpviYEzX8pi7P37+dnsEFciuZnZPbRcJRqgD2HGTIt5BrUDZ64nd1l7909ZYAEYmwKTX0sB2lLUQTgR5d2K2wDM+XV
  template:
    type: Opaque
    metadata:
      labels:
        "app.kubernetes.io/part-of": argocd
